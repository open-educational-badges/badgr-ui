<div *bgAwaitPromises="[issuerLoaded(), userProfileLoaded()]">
	<form-message></form-message>
	<div class="oeb page-padding">
		<div class="oeb-breadcrumbs">
			<bg-breadcrumbs [linkentries]="breadcrumbLinkEntries()"> </bg-breadcrumbs>
		</div>
		<div class="tw-flex tw-items-center tw-justify-between">
			<div class="tw-gap-4 tw-flex tw-items-center">
				@if (issuer().image) {
					<img
						class="md:tw-w-[93px] tw-w-[70px] tw-min-w-[70px]"
						[src]="issuer().image"
						alt="{{ issuer().name }} logo "
					/>
				}
				@if (!issuer().image) {
					<img class="topbar-x-image" [src]="issuerImagePlaceHolderUrl" alt="Default issuer image" />
				}
				<h1 hlmH1 class="tw-font-extrabold tw-text-purple">
					{{ (isCurrentUserIssuerOwner() ? 'Issuer.editMembers' : 'General.members') | translate }}
				</h1>
			</div>
			<oeb-button
				[text]="'Issuer.addMember' | translate"
				class="tw-font-semibold"
				(click)="openDialog(this.translate.instant('Issuer.addMember'))"
			></oeb-button>
		</div>
		<quota-information
			[quotas]="['ACCOUNTS_ADMIN', 'ACCOUNTS_MEMBER']"
			class="tw-block tw-mt-8 tw-text-[18px]/[1.3em]"
		/>
		<section class="tw-mt-8">
			<h2 hlmH2 class="!tw-text-oebblack tw-mb-2">{{ 'Issuer.openStaffRequests' | translate }}</h2>
			@if (staffRequests().length === 0) {
				<span class="tw-text-oebblack tw-italic tw-text-lg">{{
					'Issuer.noOpenStaffRequests' | translate
				}}</span>
			} @else {
				<issuer-staff-requests-datatable
					[requests]="staffRequests()"
					(deleteStaffRequest)="deleteStaffRequest($event)"
					(confirmStaffRequest)="confirmStaffRequest($event)"
				/>
			}
		</section>
		<section class="tw-mt-8">
			<h2 hlmH2 class="!tw-text-oebblack tw-mb-2">
				{{ 'General.members' | translate }} {{ 'General.of' | translate }} {{ issuer().name }}
			</h2>
			<div class="tw-overflow-x-auto">
				<table hlmTable oeb-table-secondary>
					<thead hlmTHead>
						@for (headerRow of table.getHeaderGroups(); track headerRow.id) {
							<tr hlmTr>
								@for (headerCell of headerRow.headers; track headerCell.id) {
									@if (!headerCell.isPlaceholder) {
										<th hlmTh>
											<div
												class="tw-flex tw-flex-row tw-items-center tw-gap-2 [&[data-sortable='true']]:tw-cursor-pointer"
												(click)="headerCell.column.toggleSorting()"
												[attr.data-sortable]="headerCell.column.getCanSort()"
											>
												<div>
													<ng-container
														*flexRender="
															headerCell.column.columnDef.header;
															props: headerCell.getContext();
															let header
														"
													>
														<div [innerHTML]="header"></div>
													</ng-container>
												</div>

												@if (headerCell.column.getIsSorted()) {
													@if (getOrderForHeaderCell(headerCell) === 'asc') {
														<ng-icon hlm size="base" name="lucideChevronUp" />
													} @else {
														<ng-icon hlm size="base" name="lucideChevronDown" />
													}
												} @else if (headerCell.column.getCanSort()) {
													<ng-icon hlm size="base" name="lucideChevronsUpDown" />
												}
											</div>
										</th>
									}
								}
							</tr>
						}
					</thead>
					<tbody hlmTBody>
						@for (row of table.getRowModel().rows; track row.id; let i = $index) {
							<tr hlmTr>
								@for (cell of row.getVisibleCells(); track cell.id) {
									<td hlmTd>
										<ng-container
											*flexRender="cell.column.columnDef.cell; props: cell.getContext(); let cell"
										>
											<div [innerHTML]="cell"></div>
										</ng-container>
									</td>
								}
							</tr>
						}
					</tbody>
				</table>
			</div>
		</section>
	</div>
</div>

<!-- Templates -->
<ng-template #dialogHeaderTemplate>
	<h1 class="tw-font-bold tw-text-oebblack tw-text-2xl tw-mb-4">{{ 'Issuer.addMember' | translate }}</h1>
	<span
		class="tw-text-purple tw-italic tw-text-lg tw-leading-[130%]"
		[innerHTML]="'Issuer.addMember_text' | translate"
	>
	</span>
</ng-template>
<ng-template #confirmDialogHeaderTemplate let-email="email">
	<h1 class="tw-font-bold tw-text-oebblack tw-text-2xl">
		{{ 'Issuer.confirmStaffRequest' | translate }}
	</h1>
	<p class="tw-text-oebblack tw-text-lg tw-mt-2 tw-mb-4 tw-leading-[130%]">
		<span [innerHTML]="'Issuer.confirmStaffRequestText1' | translate"></span>
		<span class="tw-font-bold">{{ email }}</span>
		<span [innerHTML]="'Issuer.confirmStaffRequestText2' | translate"></span>
	</p>
</ng-template>
<ng-template #addMemberFormTemplate>
	<form [formGroup]="staffCreateForm.rawControl" (ngSubmit)="submitStaffCreate()">
		<oeb-input
			class="[&_input]:tw-w-11/12"
			[control]="staffCreateForm.rawControlMap.staffEmail"
			labelStyle="tw-text-oebblack tw-text-lg tw-font-bold"
			label="{{ 'Issuer.addMember_newEmail' | translate }}"
			error="{{ 'Issuer.addMember_newEmail' | translate }}"
		>
		</oeb-input>
		<div class="tw-mt-6 tw-mb-2 tw-text-oebblack tw-text-lg tw-font-bold">
			{{ 'Issuer.addMember_chooseRole' | translate }}
		</div>
		@for (role of issuerStaffRoleOptions; track role; let last = $last) {
			<bg-formfield-radio
				[control]="staffCreateForm.rawControlMap.staffRole"
				[name]="'staffRole'"
				label="{{ role.label | translate }}"
				[value]="role.value"
				[sublabel]="role.description | translate"
				[last]="last"
				[disabled]="checkRoleDisabled(role.value)"
				errorMessage="{{ 'Issuer.addMember_selectRole' | translate }}"
			></bg-formfield-radio>
		}
		<br />

		@if (error()) {
			<div class="notification notification-warning notification-is-active tw-mb-4">
				<div class="notification-x-icon">
					<svg>
						<use xlink:href="/images/icons.svg#icon_priority_high"></use>
					</svg>
				</div>
				<div class="notification-x-text">
					<h2>{{ 'Issuer.addMember_failed' | translate }}!</h2>
					<p>{{ error() }}</p>
				</div>
			</div>
		}

		<div class="tw-w-full tw-justify-between tw-flex">
			<oeb-button
				type="button"
				size="md"
				variant="secondary"
				(click)="$event.preventDefault(); closeDialog()"
				[text]="'General.cancel' | translate"
			>
			</oeb-button>
			<oeb-button
				size="md"
				type="submit"
				[text]="'Issuer.addMember' | translate"
				[disabled]="staffCreateForm.invalid"
			>
			</oeb-button>
		</div>
	</form>
</ng-template>
<ng-template #staffRequestRoleTemplate let-requestid="requestid">
	<form [formGroup]="staffRequestRoleForm.rawControl" (ngSubmit)="submitStaffRequestRoleForm(requestid)">
		<span class="tw-text-oebblack tw-text-lg tw-font-bold">{{ 'Issuer.addMember_chooseRole' | translate }}</span>
		<section class="tw-mt-4">
			@for (role of issuerStaffRoleOptions; track role; let last = $last) {
				<bg-formfield-radio
					[control]="staffRequestRoleForm.rawControlMap.staffRole"
					[name]="'staffRole'"
					label="{{ role.label | translate }}"
					[value]="role.value"
					sublabel="{{ role.description | translate }}"
					[last]="last"
					[disabled]="checkRoleDisabled(role.value)"
					errorMessage="{{ 'Issuer.addMember_selectRole' | translate }}"
				></bg-formfield-radio>
			}
		</section>
		<br />

		@if (error()) {
			<div class="notification notification-warning notification-is-active">
				<div class="notification-x-icon">
					<svg>
						<use xlink:href="/images/icons.svg#icon_priority_high"></use>
					</svg>
				</div>
				<div class="notification-x-text">
					<h2>{{ 'Issuer.addMember_failed' | translate }}!</h2>
					<p>{{ error() }}</p>
				</div>
			</div>
		}

		<div class="tw-w-full tw-justify-between tw-flex">
			<oeb-button
				type="button"
				size="md"
				variant="secondary"
				(click)="$event.preventDefault(); closeDialog()"
				[text]="'General.cancel' | translate"
			>
			</oeb-button>
			<oeb-button
				size="md"
				type="submit"
				[text]="'Issuer.addMember' | translate"
				[disabled]="staffRequestRoleForm.invalid"
			>
				{{ 'Issuer.addMember' | translate }}
			</oeb-button>
		</div>
	</form>
</ng-template>

<ng-template #translateHeaderIDCellTemplate let-context>
	{{ context.header.id | translate }}
</ng-template>

<ng-template #roleSelectionCellTemplate let-context>
	@if (isCurrentUserIssuerOwner()) {
		<div class="forminput forminput-full">
			<div class="forminput-x-inputs">
				<select
					#memberSelect
					class="!tw-border-purple !tw-border-solid !tw-text-oebblack tw-rounded-[10px] tw-text-lg"
					[ngModel]="context.getValue()"
					[disabled]="isStaffMemberLoggedInUser(userProfile(), context.row.original)"
					(change)="changeMemberRole(context.row.original, $any(memberSelect.value))"
				>
					@for (role of issuerStaffRoleOptions; track role) {
						<option [value]="role.value" [disabled]="checkRoleDisabled(role.value, context.getValue())">
							{{ role.label | translate }}
						</option>
					}
				</select>
			</div>
		</div>
	}
</ng-template>

<ng-template #badgeActionsCellTemplate let-context>
	@if (!isStaffMemberLoggedInUser(userProfile(), context.row.original)) {
		<oeb-button
			variant="secondary"
			(click)="removeMember(context.row.original)"
			size="sm"
			width="full_width"
			[text]="'General.remove' | translate"
		/>
	}
</ng-template>
<quota-exceeded-dialog #quotasExceededDialog [issuer]="issuer()"></quota-exceeded-dialog>
